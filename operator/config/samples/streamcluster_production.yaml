apiVersion: gress.io/v1alpha1
kind: StreamCluster
metadata:
  name: gress-production-cluster
  namespace: default
spec:
  # Gress version
  version: "0.1.0"

  # Base image (optional, will use default if not specified)
  image: ghcr.io/therealutkarshpriyadarshi/gress:0.1.0
  imagePullPolicy: IfNotPresent

  # Job Manager configuration
  jobManagers:
    replicas: 3  # 3 replicas for high availability
    serviceType: ClusterIP
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi
    storage:
      size: 10Gi
      storageClassName: fast-ssd
      accessModes:
        - ReadWriteOnce
    env:
      - name: JVM_OPTS
        value: "-Xms1g -Xmx2g"
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: component
                  operator: In
                  values:
                    - jobmanager
            topologyKey: kubernetes.io/hostname
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-prod
      ingressClassName: nginx
      host: gress-ui.example.com
      tls:
        - hosts:
            - gress-ui.example.com
          secretName: gress-ui-tls

  # Task Manager configuration
  taskManagers:
    replicas: 5
    taskSlots: 2  # Each task manager can run 2 tasks
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    storage:
      size: 50Gi
      storageClassName: fast-ssd
      accessModes:
        - ReadWriteOnce
    env:
      - name: JVM_OPTS
        value: "-Xms2g -Xmx4g"
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: component
                    operator: In
                    values:
                      - taskmanager
              topologyKey: kubernetes.io/hostname
    nodeSelector:
      workload-type: stream-processing

  # High Availability configuration
  highAvailability:
    enabled: true
    mode: kubernetes  # Use Kubernetes native HA
    storageDir: /var/lib/gress/ha

  # Default state backend for jobs
  stateBackend:
    type: rocksdb
    rocksdb:
      writeBufferSize: 134217728  # 128MB
      blockCacheSize: 2147483648  # 2GB
      enableStatistics: true

  # Default checkpoint configuration
  checkpoint:
    interval: "30s"
    mode: exactly-once
    timeout: "10m"
    storage:
      type: s3
      path: s3://gress-checkpoints/production
      s3:
        bucket: gress-checkpoints
        prefix: production
        region: us-east-1
        credentialsSecret:
          name: aws-credentials

  # Monitoring configuration
  monitoring:
    enabled: true
    port: 9091
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      labels:
        prometheus: kube-prometheus

  # Logging configuration
  logging:
    level: info
    format: json
    logAggregation:
      type: fluentd
      fluentdConfig:
        fluentdHost: fluentd.logging.svc.cluster.local
        fluentdPort: "24224"

  # Network policy
  networkPolicy:
    enabled: true
    ingress:
      - from:
        - podSelector:
            matchLabels:
              app: gress
        ports:
        - protocol: TCP
          port: 6123
        - protocol: TCP
          port: 8081
    egress:
      - to:
        - podSelector:
            matchLabels:
              app: kafka
        ports:
        - protocol: TCP
          port: 9092

  # Service account
  serviceAccountName: gress-cluster-sa

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000

  # Container security context
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
